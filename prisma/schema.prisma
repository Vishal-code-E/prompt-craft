// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// User model
model User {
  id                   String                 @id @default(cuid())
  name                 String?
  email                String                 @unique
  emailVerified        DateTime?
  image                String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  defaultWorkspaceId   String?
  accounts             Account[]
  sessions             Session[]
  workspaceMembers     WorkspaceMember[]
  ownedWorkspaces      Workspace[]            @relation("WorkspaceOwner")
  prompts              Prompt[]               @relation("PromptCreator")
  promptVersions       PromptVersion[]
  auditLogs            AuditLog[]
  stripeCustomer       StripeCustomer?
  defaultWorkspace     Workspace?             @relation("DefaultWorkspace", fields: [defaultWorkspaceId], references: [id], onDelete: SetNull)
  comments             Comment[]              @relation("CommentAuthor")
  collaborationHistory CollaborationHistory[] @relation("CollaborationHistoryUser")

  @@index([email])
  @@index([defaultWorkspaceId])
}

enum WorkspacePlan {
  FREE
  PRO
  TEAM
}

// Workspace model
model Workspace {
  id                 String            @id @default(cuid())
  name               String
  ownerId            String
  plan               WorkspacePlan     @default(FREE)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  // Phase 6: Credit system fields
  creditsRemaining   Int               @default(1000) // Starting credits
  creditsUsedMonthly Int               @default(0)
  autoRefill         Boolean           @default(false)
  alertThreshold     Int               @default(150) // Alert when 15% remaining (of 1000)
  usageAlertSent     Boolean           @default(false)
  lastCreditReset    DateTime          @default(now())
  owner              User              @relation("WorkspaceOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members            WorkspaceMember[]
  prompts            Prompt[]
  auditLogs          AuditLog[]
  subscription       Subscription?
  defaultForUsers    User[]            @relation("DefaultWorkspace")
  comments           Comment[]
  usageEvents        UsageEvent[]

  @@index([ownerId])
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// Workspace membership
model WorkspaceMember {
  id          String     @id @default(cuid())
  userId      String
  workspaceId String
  role        MemberRole
  joinedAt    DateTime   @default(now())
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@index([workspaceId])
  @@index([userId])
}

// Prompt model
model Prompt {
  id                   String                 @id @default(cuid())
  workspaceId          String
  name                 String
  description          String?
  json                 Json
  toon                 String                 @db.Text
  tags                 String[]
  createdBy            String
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  workspace            Workspace              @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  creator              User                   @relation("PromptCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  versions             PromptVersion[]
  shares               PublicPromptShare[]
  comments             Comment[]
  collaborativeSession CollaborativeSession?
  collaborationHistory CollaborationHistory[]

  @@index([workspaceId])
  @@index([createdBy])
  @@index([tags])
}

// Prompt version history
model PromptVersion {
  id        String   @id @default(cuid())
  promptId  String
  version   Int
  json      Json
  toon      String   @db.Text
  createdBy String
  createdAt DateTime @default(now())
  prompt    Prompt   @relation(fields: [promptId], references: [id], onDelete: Cascade)
  creator   User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@unique([promptId, version])
  @@index([promptId])
  @@index([createdBy])
}

// Public share links
model PublicPromptShare {
  id        String    @id @default(cuid())
  promptId  String
  slug      String    @unique
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  expiresAt DateTime?
  prompt    Prompt    @relation(fields: [promptId], references: [id], onDelete: Cascade)

  @@index([promptId])
  @@index([slug])
}

// Stripe customer
model StripeCustomer {
  id               String   @id @default(cuid())
  userId           String   @unique
  stripeCustomerId String   @unique
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  PAST_DUE
  TRIALING
  UNPAID
}

// Subscription model
model Subscription {
  id                   String             @id @default(cuid())
  workspaceId          String             @unique
  stripeSubscriptionId String             @unique
  plan                 WorkspacePlan
  status               SubscriptionStatus
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  workspace            Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([stripeSubscriptionId])
}

enum AuditAction {
  PROMPT_CREATED
  PROMPT_UPDATED
  PROMPT_DELETED
  PROMPT_SHARED
  WORKSPACE_CREATED
  WORKSPACE_UPDATED
  WORKSPACE_MEMBER_ADDED
  WORKSPACE_MEMBER_REMOVED
  WORKSPACE_MEMBER_ROLE_CHANGED
  PLAN_CHANGED
  PLAN_UPGRADED
  PLAN_DOWNGRADED
  USER_INVITED
  USER_JOINED
  COMMENT_ADDED
  COMMENT_RESOLVED
  COMMENT_DELETED
  REALTIME_SESSION_JOINED
  REALTIME_SESSION_LEFT
  COLLABORATIVE_EDIT
  CREDITS_PURCHASED
  CREDITS_DEPLETED
}

// Audit log
model AuditLog {
  id          String      @id @default(cuid())
  workspaceId String
  userId      String
  action      AuditAction
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime    @default(now())
  workspace   Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// ========================================
// PHASE 5: REALTIME COLLABORATION MODELS
// ========================================

enum CommentLocationType {
  JSON
  TOON
  RULE
}

// Inline comments on prompts
model Comment {
  id          String    @id @default(cuid())
  workspaceId String
  promptId    String
  userId      String
  body        String    @db.Text
  location    Json // { type: 'json' | 'toon' | 'rule', path?: string, line?: number, nodeId?: string }
  resolved    Boolean   @default(false)
  parentId    String? // For threaded replies
  mentions    String[] // User IDs mentioned
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  prompt      Prompt    @relation(fields: [promptId], references: [id], onDelete: Cascade)
  user        User      @relation("CommentAuthor", fields: [userId], references: [id], onDelete: Cascade)
  parent      Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Comment[] @relation("CommentReplies")

  @@index([workspaceId])
  @@index([promptId])
  @@index([userId])
  @@index([parentId])
  @@index([resolved])
  @@index([createdAt])
}

// CRDT state persistence for collaborative editing
model CollaborativeSession {
  id           String   @id @default(cuid())
  promptId     String   @unique
  ydocState    Bytes? // Y.js document state
  version      Int      @default(0)
  lastSyncedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  prompt       Prompt   @relation(fields: [promptId], references: [id], onDelete: Cascade)

  @@index([lastSyncedAt])
}

// Track collaborative changes for merge history
model CollaborationHistory {
  id         String   @id @default(cuid())
  promptId   String
  userId     String
  changeType String // 'json_edit', 'toon_edit', 'rule_add', etc.
  changePath String? // JSON path or line number
  oldValue   String?  @db.Text
  newValue   String?  @db.Text
  metadata   Json? // Additional context
  createdAt  DateTime @default(now())
  prompt     Prompt   @relation(fields: [promptId], references: [id], onDelete: Cascade)
  user       User     @relation("CollaborationHistoryUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([promptId])
  @@index([userId])
  @@index([createdAt])
}

// ========================================
// PHASE 6: USAGE ANALYTICS & CREDIT SYSTEM
// ========================================

enum UsageType {
  LLM_GENERATION // Prompt generation via LLM
  PROMPT_TEST // Testing prompt execution
  API_CALL // API-based generation
  EXPORT // Export operations
  SHARE_GENERATION // Public share link generation
  BATCH_OPERATION // Bulk operations
}

// Usage event tracking
model UsageEvent {
  id           String    @id @default(cuid())
  workspaceId  String
  userId       String
  type         UsageType
  inputTokens  Int       @default(0)
  outputTokens Int       @default(0)
  creditsUsed  Int // Calculated: inputTokens/1000 + outputTokens/500
  latencyMs    Int? // Request latency
  success      Boolean   @default(true)
  errorMessage String?   @db.Text
  metadata     Json? // Additional context (model, promptId, etc.)
  createdAt    DateTime  @default(now())
  workspace    Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([workspaceId, createdAt])
}
